<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Es Store | The Ultimate Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Playfair+Display:ital,wght@1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Animation Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://unpkg.com/scrollreveal"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          emailjs.init("Ru84Q4SIEnQZjbfL4");
       })();
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        darkBg: '#080808', 
                        darkCard: '#111111',
                        accent: '#C5A059', // Champagne Gold
                        goldHover: '#E2C284'
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(197, 160, 89, 0.15)',
                        'gold-glow': '0 0 20px rgba(197, 160, 89, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden; }
        .logo-font { font-family: 'Playfair Display', serif; }
        .dark body { background-color: #080808; color: #fff; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 3px; height: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #C5A059; border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Floating Animation for Items */
        .product-card:hover { transform: translateY(-10px); }
        .product-card { transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Glossy Overlay */
        .glossy-effect::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: 0.8s;
        }
        .glossy-effect:hover::after { left: 100%; top: 100%; }

        /* Categorized Row Scroll Snap */
        .snap-row { scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .snap-item { scroll-snap-align: start; }

        .modal-content { max-height: 90vh; overflow-y: auto !important; border-radius: 2.5rem 2.5rem 0 0 !important; }
        @media (min-width: 768px) { 
            .modal-content { border-radius: 3rem !important; display: flex; flex-direction: row; overflow-y: hidden !important; } 
            .modal-scroll-area { overflow-y: auto; width: 50%; }
        }
        
        .gold-text { color: #C5A059; }
        .bg-gold { background-color: #C5A059; }
        
        .hero-overlay { background: linear-gradient(to top, #080808 0%, transparent 80%); }

        #qrcode img { margin: 0 auto; border-radius: 1rem; border: 8px solid white; }
    </style>
</head>
<body class="light">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 text-white text-center" style="background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.pexels.com/photos/3734443/pexels-photo-3734443.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover;">
        <div class="w-full max-w-sm bg-black/40 backdrop-blur-3xl p-10 rounded-[3.5rem] border border-white/10 shadow-2xl animate__animated animate__fadeIn">
            <h1 class="logo-font text-8xl italic font-black mb-10 tracking-tighter gold-text drop-shadow-lg">Es</h1>
            <div id="step-1" class="space-y-4">
                <input type="text" id="user-name-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" class="w-full p-5 rounded-2xl bg-white/5 text-center outline-none border border-white/10 focus:border-accent transition-all text-white placeholder-white/30 font-bold">
                <button id="next-btn" class="w-full bg-gold hover:bg-goldHover text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all shadow-gold-glow">ŸÖÿ™ÿßÿ®ÿπÿ©</button>
            </div>
            <div id="step-2" class="hidden space-y-4 animate__animated animate__fadeInRight">
                <input type="password" id="user-pass-input" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" class="w-full p-5 rounded-2xl bg-white/5 text-center outline-none border border-white/10 focus:border-accent transition-all text-white placeholder-white/30 font-bold">
                <button id="auth-final-btn" class="w-full bg-gold hover:bg-goldHover text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all shadow-gold-glow">ÿØÿÆŸàŸÑ</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <header class="sticky top-0 z-[100] bg-white/80 dark:bg-zinc-950/90 backdrop-blur-xl border-b border-gray-100 dark:border-white/5 transition-colors duration-500">
            <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center w-full">
                <div class="flex items-center gap-4">
                    <span class="logo-font text-4xl font-black italic cursor-pointer gold-text tracking-tight hover:scale-105 transition-transform" onclick="location.reload()">Es</span>
                    <button id="mode-toggle" class="p-2 bg-gray-50 dark:bg-white/5 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-colors">
                        <svg id="sun-icon" class="w-5 h-5 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>
                        <svg id="moon-icon" class="w-5 h-5 block dark:hidden text-zinc-600" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-toggle-btn" class="hidden bg-gold text-black px-6 py-2.5 rounded-full text-[9px] font-black uppercase tracking-[0.2em] shadow-lg">Dashboard</button>
                    <button id="cart-trigger" class="relative p-3 bg-gray-50 dark:bg-white/5 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-all">
                        <svg class="w-5 h-5 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke-width="2"/></svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-gold text-black text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-black">0</span>
                    </button>
                    <button id="logout-btn" class="p-2 text-zinc-400 hover:text-red-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7" stroke-width="2"/></svg></button>
                </div>
            </div>
        </header>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden bg-zinc-950 text-white p-6 border-b border-white/5">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12 text-right">
                <div class="space-y-5">
                    <h3 class="text-[10px] font-black uppercase gold-text tracking-[0.3em]">ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ŸÅÿßÿÆÿ±ÿ©</h3>
                    <div class="bg-white/5 p-8 rounded-[3rem] border border-white/5 space-y-4">
                        <input type="text" id="p-name" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨" class="w-full bg-black/50 p-4 rounded-2xl outline-none focus:border-accent border border-transparent">
                        <input type="number" id="p-price" placeholder="ÿßŸÑÿ≥ÿπÿ±" class="w-full bg-black/50 p-4 rounded-2xl outline-none focus:border-accent border border-transparent">
                        <input type="text" id="p-category" placeholder="ÿßŸÑŸÅÿ¶ÿ© (ŸÖÿ´ŸÑ: ÿ¥ÿ™ŸàŸäÿå ŸÉÿßÿ¨ŸàÿßŸÑ)" class="w-full bg-black/50 p-4 rounded-2xl outline-none focus:border-accent border border-transparent">
                        <input type="text" id="p-sizes" placeholder="ÿßŸÑŸÖŸÇÿßÿ≥ÿßÿ™ (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅÿßÿµŸÑÿ©)" class="w-full bg-black/50 p-4 rounded-2xl outline-none focus:border-accent border border-transparent">
                        <input type="text" id="p-main-img" placeholder="ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" class="w-full bg-black/50 p-4 rounded-2xl outline-none focus:border-accent border border-transparent">
                        <div id="colors-input-list" class="space-y-2"></div>
                        <button id="add-color-input-btn" class="text-[10px] font-black gold-text uppercase tracking-widest">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸàŸÜ ŸàÿµŸàÿ±ÿ™Ÿá</button>
                        <button id="add-product-btn" class="w-full bg-gold text-black py-5 rounded-2xl font-black uppercase tracking-widest shadow-gold-glow">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.3em] mb-6">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</h3>
                    <div id="all-orders-admin" class="space-y-4 max-h-[600px] overflow-y-auto no-scrollbar"></div>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div id="hero-section" class="relative h-[75vh] w-full overflow-hidden">
            <img src="https://images.pexels.com/photos/1884581/pexels-photo-1884581.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 hero-overlay flex flex-col items-center justify-end pb-24 text-white text-center px-6">
                <span class="text-[10px] font-black uppercase tracking-[0.6em] mb-4 opacity-70 animate__animated animate__fadeInUp">Crafted for Excellence</span>
                <h2 class="logo-font text-7xl md:text-9xl italic font-black mb-8 gold-text drop-shadow-2xl animate__animated animate__fadeInUp animate__delay-1s">Luxury Awaits</h2>
                <button onclick="document.getElementById('products-container').scrollIntoView({behavior:'smooth'})" class="px-12 py-6 bg-gold text-black rounded-full font-black uppercase text-[11px] tracking-widest hover:scale-110 transition-all shadow-gold-glow animate__animated animate__fadeInUp animate__delay-2s">Discover More</button>
            </div>
        </div>

        <!-- Categorized Products Area -->
        <main id="page-home" class="flex-1 py-20 w-full bg-zinc-50 dark:bg-darkBg transition-colors">
            <div id="products-container" class="space-y-24">
                <!-- Items and Categories injected here -->
            </div>
        </main>

        <!-- Pages -->
        <main id="page-orders" class="hidden flex-1 px-4 py-20 max-w-4xl mx-auto w-full">
            <h2 class="text-5xl font-black italic logo-font mb-12 text-center gold-text">Recent Orders</h2>
            <div id="my-orders-list" class="grid grid-cols-1 gap-6"></div>
        </main>

        <!-- Footer Nav (Mobile) -->
        <nav class="fixed bottom-0 left-0 right-0 z-[200] bg-white/90 dark:bg-black/90 backdrop-blur-2xl border-t border-white/5 flex justify-around py-6 md:hidden">
            <button onclick="window.showPage('home')" id="tab-home" class="flex flex-col items-center gap-1">
                <span class="text-[11px] font-black uppercase gold-text tracking-widest">Store</span>
            </button>
            <button onclick="window.showPage('orders')" id="tab-orders" class="flex flex-col items-center gap-1 opacity-40">
                <span class="text-[11px] font-black uppercase dark:text-white tracking-widest">History</span>
            </button>
        </nav>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 z-[2500] bg-black/90 backdrop-blur-2xl hidden flex items-end md:items-center justify-center p-0 md:p-10">
        <div class="modal-content bg-white dark:bg-zinc-950 w-full max-w-6xl relative shadow-2xl overflow-hidden border border-white/5 animate__animated animate__zoomIn animate__faster">
            <button id="close-p-modal" class="absolute top-8 right-8 z-[2600] bg-white dark:bg-zinc-800 w-12 h-12 rounded-full text-2xl flex items-center justify-center dark:text-white hover:rotate-90 transition-transform">&times;</button>
            
            <!-- Image Area -->
            <div class="w-full md:w-1/2 bg-gray-100 dark:bg-zinc-900 flex items-center justify-center p-4">
                <div class="w-full aspect-[4/5] rounded-[2rem] overflow-hidden shadow-2xl relative">
                    <img id="modal-p-image" src="" class="w-full h-full object-cover transition-all duration-700">
                </div>
            </div>

            <!-- Details Area -->
            <div class="modal-scroll-area p-10 md:p-20 text-right flex flex-col justify-center">
                <span class="text-[10px] font-black uppercase tracking-[0.4em] gold-text mb-4">Es Exclusive Edition</span>
                <h3 id="modal-p-name" class="text-5xl md:text-6xl font-black italic logo-font mb-6 dark:text-white leading-tight">Product Title</h3>
                <p id="modal-p-price" class="text-3xl font-bold text-zinc-400 italic mb-10">0 EGP</p>
                
                <div id="modal-colors-area" class="mb-10 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-500 mb-4 tracking-widest">ÿßÿÆÿ™ÿ± ÿßŸÑŸÑŸàŸÜ</p>
                    <div id="modal-colors-list" class="flex flex-wrap gap-4 justify-end"></div>
                </div>

                <div id="modal-sizes-area" class="mb-12 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-500 mb-4 tracking-widest">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÇÿßÿ≥</p>
                    <div id="modal-sizes-list" class="flex flex-wrap gap-3 justify-end"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="checkout-direct-btn" class="bg-gold text-black py-6 rounded-2xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform shadow-gold-glow">ÿ¥ÿ±ÿßÿ° ŸÅŸàÿ±Ÿä</button>
                    <button id="modal-add-btn" class="bg-transparent text-black dark:text-white border border-zinc-200 dark:border-white/10 py-6 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-50 dark:hover:bg-white/5 transition-colors">ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qr-modal" class="fixed inset-0 z-[2700] bg-black/90 backdrop-blur-xl hidden flex items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div class="bg-white dark:bg-zinc-900 p-10 rounded-[3.5rem] text-center space-y-8 max-w-xs w-full shadow-2xl border border-white/10 animate__animated animate__pulse">
            <h4 class="font-black italic text-2xl dark:text-white">Scan & Discover</h4>
            <div id="qrcode" class="flex justify-center p-6 bg-white rounded-3xl"></div>
            <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-[0.2em]">Exclusive product access code</p>
        </div>
    </div>

    <!-- Shipping Modal -->
    <div id="shipping-modal" class="fixed inset-0 z-[2600] bg-black/70 backdrop-blur-xl hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-950 w-full max-w-md rounded-[4rem] p-12 shadow-2xl text-right border border-white/10 animate__animated animate__fadeInUp">
            <h2 class="text-4xl font-black italic logo-font mb-10 text-center gold-text">Order Info</h2>
            <div class="space-y-4">
                <input type="text" id="ship-fullname" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ" class="w-full p-6 rounded-[1.5rem] bg-gray-50 dark:bg-white/5 dark:text-white border-none outline-none font-bold">
                <input type="tel" id="ship-phone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ" class="w-full p-6 rounded-[1.5rem] bg-gray-50 dark:bg-white/5 dark:text-white border-none outline-none font-bold text-left">
                <textarea id="ship-address" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ" class="w-full p-6 rounded-[1.5rem] bg-gray-50 dark:bg-white/5 dark:text-white border-none outline-none h-32 font-bold"></textarea>
                <button id="save-shipping-btn" class="w-full bg-gold text-black py-7 rounded-[1.5rem] font-black uppercase tracking-widest shadow-gold-glow">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®</button>
            </div>
            <button onclick="document.getElementById('shipping-modal').classList.add('hidden')" class="w-full mt-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">ÿ•ŸÑÿ∫ÿßÿ°</button>
        </div>
    </div>

    <!-- Cart Drawer -->
    <div id="cart-drawer" class="fixed inset-0 z-[2400] bg-black/60 backdrop-blur-lg hidden text-right">
        <div id="cart-inner" class="absolute left-0 top-0 h-full w-full max-w-md bg-white dark:bg-zinc-950 p-12 flex flex-col transform -translate-x-full transition-transform duration-700">
            <h2 class="text-5xl font-black italic logo-font mb-12 gold-text">Your Selection</h2>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-6 no-scrollbar pr-2"></div>
            <div class="pt-10 border-t border-gray-100 dark:border-white/5 mt-8">
                <div class="flex justify-between font-black text-3xl mb-10 italic dark:text-white"><span>Total</span><span id="cart-total" class="gold-text">0 EGP</span></div>
                <button id="checkout-cart-btn" class="w-full bg-black dark:bg-gold dark:text-black text-white py-7 rounded-[2.5rem] font-black uppercase text-sm tracking-widest shadow-2xl">Proceed to Checkout</button>
            </div>
            <button id="cart-close" class="mt-8 text-[11px] font-black text-zinc-400 uppercase tracking-widest">ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ≥ŸÑÿ©</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRVGDn1M_zy5p7HGsNV0dLweMKRs_5JzA",
            authDomain: "elshla.firebaseapp.com",
            databaseURL: "https://elshla-default-rtdb.firebaseio.com",
            projectId: "elshla",
            storageBucket: "elshla.firebasestorage.app",
            messagingSenderId: "225364230201",
            appId: "1:225364230201:web:ffa36b14888763a1e64de8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rdb = getDatabase(app);
        const DB_ROOT = "es_v_admin_pro"; 

        let profile = null; let cart = [];
        let curImg = ""; let curSz = ""; let isDirect = false; let currentProductId = ""; let curHex = "Default"; 

        const showNotify = (msg, color="#C5A059") => {
            Toastify({ text: msg, duration: 4000, gravity: "top", position: "center", style: { background: color, color: "#000", borderRadius: "25px", fontWeight: "900", boxShadow: "0 10px 30px rgba(0,0,0,0.1)" } }).showToast();
        };

        // ScrollReveal for smooth entries
        const sr = ScrollReveal({ distance: '50px', duration: 1000, easing: 'cubic-bezier(0.5, 0, 0, 1)', interval: 100 });

        onAuthStateChanged(auth, async (u) => {
            const saved = localStorage.getItem('es_session_v4');
            if(saved) {
                onValue(ref(rdb, `${DB_ROOT}/users/${saved}`), (s) => {
                    profile = s.val();
                    if(profile) {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        if(profile.role === 'admin') document.getElementById('admin-toggle-btn').classList.remove('hidden');
                        loadData();
                    }
                });
            }
        });

        function loadData() {
            onValue(ref(rdb, `${DB_ROOT}/products`), (snap) => {
                const container = document.getElementById('products-container'); container.innerHTML = '';
                const data = snap.val(); if(!data) return;

                const categories = {};
                Object.keys(data).reverse().forEach(id => {
                    const p = data[id];
                    const cat = p.category || "General Collection";
                    if(!categories[cat]) categories[cat] = [];
                    categories[cat].push({ id, ...p });
                });

                Object.entries(categories).forEach(([catName, items]) => {
                    const section = document.createElement('div');
                    section.className = "space-y-8 animate-reveal";
                    section.innerHTML = `
                        <div class="px-8 flex justify-between items-end">
                            <div class="text-right">
                                <h3 class="logo-font text-4xl font-black italic dark:text-white">${catName}</h3>
                                <div class="h-1.5 w-16 bg-gold mt-4 rounded-full"></div>
                            </div>
                        </div>
                        <div class="flex overflow-x-auto gap-8 px-8 pb-10 no-scrollbar snap-row">
                            ${items.map(p => `
                                <div class="snap-item min-w-[260px] md:min-w-[340px] product-card group cursor-pointer" onclick="window.openProductModal('${p.id}','${p.name}',${p.price},'${p.image}','${encodeURIComponent(JSON.stringify(p.colors||[])).replace(/'/g, "\\'")}','${encodeURIComponent(JSON.stringify(p.sizes||[])).replace(/'/g, "\\'")}')">
                                    <div class="aspect-[3/4] rounded-[3rem] overflow-hidden bg-white dark:bg-darkCard relative shadow-lg group-hover:shadow-gold-glow transition-all duration-500 glossy-effect">
                                        <img src="${p.image}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-1000">
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                                        ${profile?.role==='admin'?`<button onclick="event.stopPropagation(); window.delP('${p.id}')" class="absolute top-6 right-6 bg-red-600 text-white w-10 h-10 rounded-full z-10 shadow-xl">&times;</button>`:''}
                                    </div>
                                    <div class="mt-8 text-center">
                                        <h4 class="font-black italic text-sm uppercase dark:text-white tracking-[0.2em]">${p.name}</h4>
                                        <p class="gold-text font-black text-xs mt-2">${p.price} EGP</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });
                sr.reveal('.animate-reveal');
                sr.reveal('.product-card', { interval: 150 });
            });

            onValue(ref(rdb, `${DB_ROOT}/orders`), (snap) => {
                const my = document.getElementById('my-orders-list');
                const adm = document.getElementById('all-orders-admin');
                my.innerHTML = ''; adm.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.entries(data).reverse().forEach(([id, o]) => {
                    if(profile && o.userName === profile.name) {
                        my.innerHTML += `<div class="bg-white dark:bg-white/5 p-8 rounded-[2.5rem] flex justify-between items-center text-right shadow-sm border border-gray-100 dark:border-white/5 animate__animated animate__fadeIn">
                            <div><p class="font-black text-sm dark:text-white mb-2">${o.items.map(i=>i.name).join(' & ')}</p><span class="text-[10px] bg-gold/20 gold-text px-4 py-1.5 rounded-full font-black uppercase tracking-widest">${o.status}</span></div>
                            <div class="font-black text-xl gold-text">${o.total}</div>
                        </div>`;
                    }
                    if(profile?.role==='admin') {
                        adm.innerHTML += `<div class="bg-white/5 p-8 rounded-[2.5rem] text-[10px] space-y-4 border border-white/5">
                            <div class="flex justify-between font-black uppercase text-zinc-400"><span>üë§ ${o.shipping.name}</span><span class="gold-text">${o.total} EGP</span></div>
                            <div class="text-white/60 leading-relaxed">${o.items.map(i=>`${i.name} [${i.sz}]`).join('<br>')}</div>
                            <div class="flex gap-2 pt-4">
                                <button onclick="window.processOrder('${id}', 'ÿ™ŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ', '${encodeURIComponent(JSON.stringify(o))}')" class="flex-1 bg-gold text-black py-3 rounded-xl font-black uppercase">ÿ™ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ ‚úÖ</button>
                                <button onclick="window.upStatus('${id}','ÿ≠ÿ∞ŸÅ')" class="bg-red-900/40 px-6 py-3 rounded-xl text-red-400 font-bold">üóëÔ∏è</button>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        window.openProductModal = (id, n, p, img, cJ, sJ) => {
            currentProductId = id;
            const colors = JSON.parse(decodeURIComponent(cJ));
            const sizes = JSON.parse(decodeURIComponent(sJ));
            document.getElementById('modal-p-image').src = img;
            document.getElementById('modal-p-name').innerText = n;
            document.getElementById('modal-p-price').innerText = p + " EGP";
            curImg = img; curSz = sizes[0] || ""; curHex = "Default";

            const cl = document.getElementById('modal-colors-list'); cl.innerHTML = '';
            if(colors.length) {
                document.getElementById('modal-colors-area').classList.remove('hidden');
                colors.forEach((c, idx) => {
                    const dot = document.createElement('div'); 
                    dot.className = `w-10 h-10 rounded-full border-2 border-zinc-200 cursor-pointer transition-all ${idx===0?'ring-2 ring-gold ring-offset-4 dark:ring-offset-zinc-950 scale-110':''}`;
                    dot.style.backgroundColor = c.hex;
                    dot.onclick = () => { 
                        document.querySelectorAll('#modal-colors-list div').forEach(d=>d.className = "w-10 h-10 rounded-full border-2 border-zinc-200 cursor-pointer transition-all"); 
                        dot.className = "w-10 h-10 rounded-full border-2 border-zinc-200 cursor-pointer transition-all ring-2 ring-gold ring-offset-4 dark:ring-offset-zinc-950 scale-110";
                        document.getElementById('modal-p-image').src = c.img; 
                        curImg = c.img; curHex = c.hex;
                    };
                    cl.appendChild(dot);
                });
            } else document.getElementById('modal-colors-area').classList.add('hidden');

            const sl = document.getElementById('modal-sizes-list'); sl.innerHTML = '';
            if(sizes.length) {
                document.getElementById('modal-sizes-area').classList.remove('hidden');
                sizes.forEach((s, idx) => {
                    const btn = document.createElement('button'); 
                    btn.className = `px-8 py-3 rounded-xl font-black text-[10px] tracking-widest transition-all ${idx===0?'bg-gold text-black':'bg-gray-100 dark:bg-white/5 dark:text-white'}`; 
                    btn.innerText = s;
                    btn.onclick = () => { 
                        document.querySelectorAll('#modal-sizes-list button').forEach(b=>b.className = "px-8 py-3 rounded-xl font-black text-[10px] tracking-widest bg-gray-100 dark:bg-white/5 dark:text-white"); 
                        btn.className = "px-8 py-3 rounded-xl font-black text-[10px] tracking-widest bg-gold text-black"; 
                        curSz = s; 
                    };
                    sl.appendChild(btn);
                });
            } else document.getElementById('modal-sizes-area').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        };

        document.getElementById('save-shipping-btn').onclick = async () => {
            const sh = { name: document.getElementById('ship-fullname').value, phone: document.getElementById('ship-phone').value, address: document.getElementById('ship-address').value };
            if(!sh.name || !sh.phone || !sh.address) return showNotify("‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ŸÉÿßŸÅÿ© ÿßŸÑÿ≠ŸÇŸàŸÑ","red");
            const items = isDirect ? [{ name: document.getElementById('modal-p-name').innerText, price: parseInt(document.getElementById('modal-p-price').innerText), sz: curSz, img: curImg, hex: curHex, qty: 1 }] : cart;
            const total = items.reduce((acc, i) => acc + (i.price * i.qty), 0);
            await push(ref(rdb, `${DB_ROOT}/orders`), { userName: profile.name, items, total, shipping: sh, status: 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', timestamp: Date.now() });
            if(!isDirect) cart = [];
            window.updateCartUI();
            ['shipping-modal', 'product-modal', 'cart-drawer'].forEach(m=>document.getElementById(m).classList.add('hidden'));
            showNotify("‚ú® ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÇÿ±Ÿäÿ®ÿßŸã.");
        };

        window.updateCartUI = () => {
            document.getElementById('cart-count').innerText = cart.reduce((acc, i) => acc + i.qty, 0);
            const container = document.getElementById('cart-items'); container.innerHTML = '';
            let total = 0;
            cart.forEach((item, idx) => {
                total += item.price * item.qty;
                container.innerHTML += `<div class="flex items-center gap-6 bg-zinc-50 dark:bg-white/5 p-6 rounded-[2rem] animate__animated animate__fadeInLeft">
                    <img src="${item.img}" class="w-20 h-24 object-cover rounded-2xl shadow-xl">
                    <div class="flex-1">
                        <h4 class="font-black text-xs dark:text-white uppercase tracking-widest mb-1">${item.name}</h4>
                        <p class="gold-text font-black text-[10px]">${item.sz} | ${item.price} EGP</p>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <button onclick="window.changeQty(${idx},1)" class="w-8 h-8 bg-white dark:bg-zinc-800 rounded-lg text-xs font-black dark:text-gold">+</button>
                        <span class="text-xs font-black dark:text-white">${item.qty}</span>
                        <button onclick="window.changeQty(${idx},-1)" class="w-8 h-8 bg-white dark:bg-zinc-800 rounded-lg text-xs font-black dark:text-gold">-</button>
                    </div>
                </div>`;
            });
            document.getElementById('cart-total').innerText = total + " EGP";
        };

        window.changeQty = (idx, delta) => { cart[idx].qty += delta; if(cart[idx].qty < 1) cart.splice(idx, 1); window.updateCartUI(); };
        window.showPage = (id) => {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            document.getElementById('hero-section').classList.toggle('hidden', id !== 'home');
        };

        document.getElementById('modal-add-btn').onclick = () => {
            cart.push({ name: document.getElementById('modal-p-name').innerText, price: parseInt(document.getElementById('modal-p-price').innerText), sz: curSz, img: curImg, hex: curHex, qty: 1 });
            window.updateCartUI(); 
            showNotify("‚úÖ ÿ£ÿ∂ŸäŸÅ ÿ•ŸÑŸâ ÿ≠ŸÇŸäÿ®ÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ");
        };

        document.getElementById('cart-trigger').onclick = () => {
            document.getElementById('cart-drawer').classList.remove('hidden');
            setTimeout(() => document.getElementById('cart-inner').classList.remove('-translate-x-full'), 10);
        };

        document.getElementById('cart-close').onclick = () => {
            document.getElementById('cart-inner').classList.add('-translate-x-full');
            setTimeout(() => document.getElementById('cart-drawer').classList.add('hidden'), 500);
        };

        document.getElementById('close-p-modal').onclick = () => {
            const modal = document.getElementById('product-modal');
            modal.querySelector('.modal-content').classList.replace('animate__zoomIn', 'animate__zoomOut');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.querySelector('.modal-content').classList.replace('animate__zoomOut', 'animate__zoomIn');
            }, 300);
        };

        document.getElementById('checkout-direct-btn').onclick = () => { isDirect = true; document.getElementById('shipping-modal').classList.remove('hidden'); };
        document.getElementById('checkout-cart-btn').onclick = () => { if(cart.length) { isDirect = false; document.getElementById('shipping-modal').classList.remove('hidden'); } };

        document.getElementById('admin-toggle-btn').onclick = () => document.getElementById('admin-panel').classList.toggle('hidden');

        document.getElementById('add-product-btn').onclick = async () => {
            const p = { 
                name: document.getElementById('p-name').value, 
                price: parseInt(document.getElementById('p-price').value), 
                category: document.getElementById('p-category').value || "General Collection",
                image: document.getElementById('p-main-img').value, 
                sizes: document.getElementById('p-sizes').value.split(',').map(s=>s.trim()), 
                colors: [] 
            };
            document.querySelectorAll('#colors-input-list > div').forEach(div => {
                p.colors.push({ img: div.querySelector('.c-img').value, hex: div.querySelector('.c-hex').value });
            });
            await push(ref(rdb, `${DB_ROOT}/products`), p);
            showNotify("üíé ÿ™ŸÖ ÿ•ÿØÿ±ÿßÿ¨ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠");
            document.getElementById('admin-panel').classList.add('hidden');
        };

        document.getElementById('add-color-input-btn').onclick = () => {
            const div = document.createElement('div'); div.className = "flex gap-2 p-3 bg-white/5 rounded-2xl animate__animated animate__fadeIn";
            div.innerHTML = `<input type="text" placeholder="ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑŸÑŸàŸÜ" class="flex-1 bg-transparent p-2 text-[10px] c-img outline-none text-white"><input type="color" class="w-10 h-10 rounded-xl c-hex cursor-pointer bg-transparent border-none"><button onclick="this.parentElement.remove()" class="text-red-500 font-black px-2">&times;</button>`;
            document.getElementById('colors-input-list').appendChild(div);
        };

        document.getElementById('mode-toggle').onclick = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
        if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        document.getElementById('next-btn').onclick = () => {
            if(document.getElementById('user-name-input').value) {
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
            }
        };

        document.getElementById('auth-final-btn').onclick = async () => {
            const n = document.getElementById('user-name-input').value.trim();
            const p = document.getElementById('user-pass-input').value.trim();
            const snap = await get(ref(rdb, `${DB_ROOT}/users/${n}`));
            if(!snap.exists()) {
                await signInAnonymously(auth);
                await set(ref(rdb, `${DB_ROOT}/users/${n}`), { name: n, password: p, role: (n.toLowerCase()==='admin'?'admin':'user') });
            } else if(snap.val().password !== p) return showNotify("‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±", "#f00");
            localStorage.setItem('es_session_v4', n); location.reload();
        };

        document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };
        window.delP = (id) => { if(confirm("ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü")) remove(ref(rdb, `${DB_ROOT}/products/${id}`)); };
        window.upStatus = (id, st) => { if(st==='ÿ≠ÿ∞ŸÅ') remove(ref(rdb, `${DB_ROOT}/orders/${id}`)); };
        
        window.processOrder = async (id, status, oRaw) => {
            const o = JSON.parse(decodeURIComponent(oRaw));
            await update(ref(rdb, `${DB_ROOT}/orders/${id}`), { status: status });
            const msg = `ÿ£ŸáŸÑÿßŸã ${o.shipping.name}ÿå ÿ∑ŸÑÿ®ŸÉ ŸÖŸÜ Es Store ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá ÿ•ŸÑŸâ: ${status}`;
            window.open(`https://wa.me/${o.shipping.phone.replace('+', '')}?text=${encodeURIComponent(msg)}`, '_blank');
        };
    </script>
</body>
</html>