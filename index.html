<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Es Store | The Ultimate Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Playfair+Display:ital,wght@1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- EmailJS Integration -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          emailjs.init("Ru84Q4SIEnQZjbfL4"); // ŸÖŸÅÿ™ÿßÿ≠ŸÉ ÿßŸÑÿÆÿßÿµ
       })();
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { darkBg: '#0a0a0a', darkCard: '#141414' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; transition: background-color 0.5s ease, color 0.5s ease; }
        .logo-font { font-family: 'Playfair Display', serif; }
        .dark body { background-color: #0a0a0a; color: #fff; }
        .modal-content { 
            max-height: 90vh; 
            overflow-y: auto !important; 
            border-radius: 2.5rem 2.5rem 0 0 !important; 
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) { 
            .modal-content { border-radius: 4rem !important; max-height: 85vh; flex-direction: row; overflow-y: hidden !important; } 
            .modal-scroll-area { overflow-y: auto; max-height: 85vh; }
        }
        .hero-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8)); }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #eee; position: relative; cursor: pointer; }
        .color-dot.active { border-color: #000; transform: scale(1.1); }
        .dark .color-dot.active { border-color: #fff; }
        .size-btn { padding: 12px 20px; border-radius: 12px; border: 1.5px solid #eee; font-weight: 800; transition: 0.3s; }
        .size-btn.active { background: #000; color: #fff; border-color: #000; }
        .dark .size-btn.active { background: #fff; color: #000; border-color: #fff; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
    </style>
</head>
<body class="light">

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ -->
    <div id="login-screen" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 text-white text-center" style="background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.pexels.com/photos/1183266/pexels-photo-1183266.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover;">
        <div class="w-full max-w-sm bg-white/5 backdrop-blur-2xl p-10 rounded-[3.5rem] border border-white/10 text-center">
            <h1 class="logo-font text-8xl italic font-black mb-10">Es</h1>
            <div id="step-1" class="space-y-4">
                <input type="text" id="user-name-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" class="w-full p-5 rounded-2xl bg-white/10 text-center outline-none border border-white/5 focus:border-white/30">
                <button id="next-btn" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95">ŸÖÿ™ÿßÿ®ÿπÿ©</button>
            </div>
            <div id="step-2" class="hidden space-y-4">
                <input type="password" id="user-pass-input" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" class="w-full p-5 rounded-2xl bg-white/10 text-center outline-none border border-white/5 focus:border-white/30">
                <button id="auth-final-btn" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95">ÿØÿÆŸàŸÑ</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <!-- ÿßŸÑŸáŸäÿØÿ± -->
        <header class="sticky top-0 z-[100] bg-white/80 dark:bg-zinc-950/80 backdrop-blur-lg border-b border-gray-100 dark:border-zinc-900">
            <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center w-full">
                <div class="flex items-center gap-4">
                    <span class="logo-font text-4xl font-black italic cursor-pointer dark:text-white" onclick="location.reload()">Es</span>
                    <button id="mode-toggle" class="p-2 bg-gray-100 dark:bg-zinc-800 rounded-full">
                        <svg id="sun-icon" class="w-5 h-5 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>
                        <svg id="moon-icon" class="w-5 h-5 block dark:hidden text-zinc-600" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-toggle-btn" class="hidden bg-black dark:bg-white dark:text-black text-white px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-[0.2em]">Dashboard</button>
                    <button id="cart-trigger" class="relative p-3 bg-gray-50 dark:bg-zinc-800 rounded-full">
                        <svg class="w-5 h-5 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke-width="2"/></svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-black">0</span>
                    </button>
                    <button id="logout-btn" class="p-2 text-zinc-400 hover:text-red-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7" stroke-width="2"/></svg></button>
                </div>
            </div>
        </header>

        <!-- Hero Section -->
        <div id="hero-section" class="relative h-[70vh] w-full overflow-hidden">
            <img src="https://images.pexels.com/photos/1884581/pexels-photo-1884581.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 hero-gradient flex flex-col items-center justify-center text-white text-center px-6">
                <span class="text-[10px] font-black uppercase tracking-[0.6em] mb-4 opacity-70">Es Store Official</span>
                <h2 class="logo-font text-6xl md:text-8xl italic font-black mb-6">Style is Eternal</h2>
                <button onclick="document.getElementById('products-grid').scrollIntoView({behavior:'smooth'})" class="mt-10 px-10 py-5 bg-white text-black rounded-full font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all">Shop Collection</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="admin-panel" class="hidden bg-zinc-950 text-white p-6 border-b-[12px] border-black">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
                <div class="space-y-5">
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.3em]">Publish Product</h3>
                    <div class="bg-white/5 p-6 rounded-[2.5rem] border border-white/5 space-y-4">
                        <input type="text" id="p-name" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <input type="number" id="p-price" placeholder="ÿßŸÑÿ≥ÿπÿ±" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <input type="text" id="p-sizes" placeholder="ÿßŸÑŸÖŸÇÿßÿ≥ÿßÿ™ (S, M, L...)" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <div id="colors-input-list" class="space-y-2">
                            <div class="flex gap-2">
                                <input type="text" placeholder="ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑŸÑŸàŸÜ" class="flex-1 bg-white/5 p-3 rounded-xl text-xs c-img">
                                <input type="color" class="w-12 h-12 rounded-xl c-hex cursor-pointer" value="#000000">
                            </div>
                        </div>
                        <button onclick="window.addColorInput()" class="text-[10px] font-black text-blue-400 uppercase tracking-widest">+ Add Variation</button>
                        <button id="add-product-btn" class="w-full bg-white text-black py-5 rounded-[1.5rem] font-black uppercase tracking-[0.2em]">Publish Now</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.3em] mb-6">Live Orders</h3>
                    <div id="all-orders-admin" class="space-y-4 max-h-[600px] overflow-y-auto pr-3"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main id="page-home" class="flex-1 px-4 py-16 max-w-7xl mx-auto w-full">
            <div class="mb-16 text-center">
                <h3 class="logo-font text-5xl italic font-black mb-2 dark:text-white">The Collection</h3>
                <div class="w-20 h-1 bg-black dark:bg-white mx-auto"></div>
            </div>
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-12"></div>
        </main>

        <main id="page-orders" class="hidden flex-1 px-4 py-12 max-w-3xl mx-auto w-full">
            <h2 class="text-4xl font-black italic logo-font mb-12 text-center dark:text-white">Order History</h2>
            <div id="my-orders-list" class="space-y-4"></div>
        </main>

        <!-- Navbar Mobile -->
        <nav class="fixed bottom-0 left-0 right-0 z-[200] bg-white/90 dark:bg-zinc-900/90 backdrop-blur-xl border-t border-gray-100 dark:border-zinc-800 flex justify-around py-4 md:hidden">
            <button onclick="window.showPage('home')" id="tab-home" class="flex flex-col items-center gap-1 border-b-2 border-black dark:border-white pb-1">
                <span class="text-[10px] font-black uppercase tracking-widest dark:text-white">Store</span>
            </button>
            <button onclick="window.showPage('orders')" id="tab-orders" class="flex flex-col items-center gap-1 opacity-40 pb-1">
                <span class="text-[10px] font-black uppercase tracking-widest dark:text-white">My Orders</span>
            </button>
        </nav>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 z-[2500] bg-black/70 backdrop-blur-xl hidden flex items-end md:items-center justify-center">
        <div class="modal-content bg-white dark:bg-zinc-900 w-full max-w-5xl relative shadow-2xl overflow-hidden">
            <button id="close-p-modal" class="absolute top-6 right-6 z-[2600] bg-white dark:bg-zinc-800 shadow-xl w-12 h-12 rounded-full text-3xl flex items-center justify-center font-light dark:text-white">&times;</button>
            
            <button id="share-p-btn" class="absolute top-6 left-6 z-[2600] bg-white dark:bg-zinc-800 shadow-xl w-12 h-12 rounded-full flex items-center justify-center dark:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke-width="2"/></svg>
            </button>

            <div class="w-full md:w-1/2 bg-gray-50 dark:bg-zinc-800 p-4 md:p-10 flex items-center justify-center">
                <div class="w-full aspect-[4/5] rounded-[2.5rem] overflow-hidden bg-white shadow-2xl">
                    <img id="modal-p-image" src="" class="w-full h-full object-cover">
                </div>
            </div>
            
            <div class="w-full md:w-1/2 p-8 md:p-16 flex flex-col justify-center modal-scroll-area bg-white dark:bg-zinc-900">
                <div class="mb-10">
                    <span class="text-[10px] font-black uppercase tracking-[0.4em] text-zinc-400">Es Store Premium</span>
                    <h3 id="modal-p-name" class="text-4xl md:text-5xl font-black italic logo-font my-3 dark:text-white">Product</h3>
                    <p id="modal-p-price" class="text-2xl font-black text-zinc-300 italic">0 EGP</p>
                </div>
                
                <div id="modal-colors-area" class="mb-8 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-400 mb-4 tracking-[0.2em]">Colors</p>
                    <div id="modal-colors-list" class="flex flex-wrap gap-4"></div>
                </div>
                
                <div id="modal-sizes-area" class="mb-10 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-400 mb-4 tracking-[0.2em]">Size</p>
                    <div id="modal-sizes-list" class="flex flex-wrap gap-3"></div>
                </div>
                
                <div class="space-y-4 pb-10">
                    <div class="flex items-center justify-between bg-zinc-50 dark:bg-zinc-800 p-5 rounded-[2rem]">
                        <div class="text-right leading-tight"><p class="text-[10px] font-black text-zinc-400 uppercase">Authentication</p><p class="text-[12px] font-black dark:text-white">ÿ£ÿµŸÑŸä 100%</p></div>
                        <div id="qr-code" class="qr-container bg-white p-1 rounded-xl shadow-sm"></div>
                    </div>
                    <button id="checkout-direct-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-2xl font-black uppercase text-xs tracking-[0.2em]">Buy Now</button>
                    <button id="modal-add-btn" class="w-full bg-white dark:bg-zinc-800 text-black dark:text-white border-2 border-zinc-100 dark:border-zinc-700 py-6 rounded-2xl font-black uppercase text-xs tracking-[0.2em]">Add to Bag</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipping Modal -->
    <div id="shipping-modal" class="fixed inset-0 z-[2600] bg-black/60 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl">
            <h2 class="text-3xl font-black italic logo-font mb-8 text-center dark:text-white">Shipping</h2>
            <div class="space-y-4">
                <input type="text" id="ship-fullname" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none font-bold">
                <input type="tel" id="ship-phone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none font-bold">
                <textarea id="ship-address" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none h-28 font-bold"></textarea>
                <button id="save-shipping-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-2xl font-black uppercase tracking-widest">Place Order</button>
            </div>
        </div>
    </div>

    <div id="cart-drawer" class="fixed inset-0 z-[2400] bg-black/40 hidden text-right">
        <div id="cart-inner" class="absolute left-0 top-0 h-full w-full max-w-sm bg-white dark:bg-zinc-900 p-10 flex flex-col transform translate-x-full transition-transform duration-500">
            <h2 class="text-4xl font-black italic logo-font mb-10 dark:text-white">My Bag</h2>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-5"></div>
            <div class="pt-8 border-t dark:border-zinc-800 mt-6">
                <div class="flex justify-between font-black text-2xl mb-8 italic dark:text-white"><span>Total</span><span id="cart-total">0 EGP</span></div>
                <button id="checkout-cart-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-[2rem] font-black uppercase text-xs tracking-widest">Checkout</button>
            </div>
            <button id="cart-close" class="mt-6 text-[10px] font-black text-zinc-400 uppercase tracking-widest text-center">Close Drawer</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRVGDn1M_zy5p7HGsNV0dLweMKRs_5JzA",
            authDomain: "elshla.firebaseapp.com",
            databaseURL: "https://elshla-default-rtdb.firebaseio.com",
            projectId: "elshla",
            storageBucket: "elshla.firebasestorage.app",
            messagingSenderId: "225364230201",
            appId: "1:225364230201:web:ffa36b14888763a1e64de8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rdb = getDatabase(app);
        const DB_ROOT = "es_v_admin_pro"; 

        let profile = null; let cart = [];
        let curImg = ""; let curSz = ""; let isDirect = false;

        const showNotify = (msg, color="#000") => {
            Toastify({ text: msg, duration: 3000, style: { background: color, borderRadius: "20px", fontWeight: "bold" } }).showToast();
        };

        // --- Dark/Light Mode ---
        const modeToggle = document.getElementById('mode-toggle');
        const handleTheme = (theme) => {
            if (theme === 'dark') { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
            else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
        };
        modeToggle.onclick = () => handleTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark');
        if (localStorage.getItem('theme') === 'dark') handleTheme('dark');

        // --- Email Notification Logic ---
        const sendAdminEmail = (orderData) => {
            const itemsList = orderData.items.map(i => `${i.name} (ŸÖŸÇÿßÿ≥: ${i.sz})`).join(', ');
            const emailParams = {
                to_name: "Admin",
                from_name: orderData.shipping.name,
                order_id: Math.random().toString(36).substr(2, 9).toUpperCase(),
                customer_name: orderData.shipping.name,
                customer_phone: orderData.shipping.phone,
                customer_address: orderData.shipping.address,
                order_items: itemsList,
                total_price: orderData.total,
                reply_to: "no-reply@es-store.com"
            };

            emailjs.send("service_elshla", "template_es_store", emailParams)
                .then(() => console.log("Email Sent Successfully!"))
                .catch((err) => console.error("Email Error:", err));
        };

        // --- Core Logic ---
        onAuthStateChanged(auth, (u) => {
            const saved = localStorage.getItem('es_session_v4');
            if(saved) {
                onValue(ref(rdb, `${DB_ROOT}/users/${saved}`), (s) => {
                    profile = s.val();
                    if(profile) {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        if(profile.role === 'admin') document.getElementById('admin-toggle-btn').classList.remove('hidden');
                        loadData();
                    }
                });
            }
        });

        function loadData() {
            onValue(ref(rdb, `${DB_ROOT}/products`), (snap) => {
                const grid = document.getElementById('products-grid'); grid.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.keys(data).reverse().forEach(id => {
                    const p = data[id];
                    const cS = encodeURIComponent(JSON.stringify(p.colors || []));
                    const sS = encodeURIComponent(JSON.stringify(p.sizes || []));
                    grid.innerHTML += `
                        <div class="group cursor-pointer" onclick="window.openProductModal('${id}','${p.name}',${p.price},'${p.image}','${cS}','${sS}')">
                            <div class="aspect-[3/4] rounded-[2.5rem] overflow-hidden bg-gray-50 dark:bg-zinc-800 relative">
                                <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                ${profile.role==='admin'?`<button onclick="event.stopPropagation(); window.delP('${id}')" class="absolute top-4 right-4 bg-red-600 text-white w-8 h-8 rounded-full">√ó</button>`:''}
                            </div>
                            <div class="mt-5 px-2 text-center">
                                <h4 class="font-black italic text-sm uppercase dark:text-white">${p.name}</h4>
                                <p class="text-zinc-400 font-bold text-xs">${p.price} EGP</p>
                            </div>
                        </div>`;
                });
            });

            onValue(ref(rdb, `${DB_ROOT}/orders`), (snap) => {
                const my = document.getElementById('my-orders-list');
                const adm = document.getElementById('all-orders-admin');
                my.innerHTML = ''; adm.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.entries(data).reverse().forEach(([id, o]) => {
                    if(o.userName === profile.name) {
                        my.innerHTML += `<div class="bg-gray-50 dark:bg-zinc-800 p-6 rounded-[2rem] flex justify-between items-center text-right shadow-sm">
                            <div><p class="font-black text-xs uppercase dark:text-white">${o.items.map(i=>i.name).join(', ')}</p><p class="text-[10px] text-zinc-400 mt-1 uppercase font-bold">${o.status}</p></div>
                            <div class="font-black dark:text-white">${o.total}</div>
                        </div>`;
                    }
                    if(profile.role==='admin') {
                        adm.innerHTML += `<div class="bg-white/5 p-6 rounded-3xl text-[10px] space-y-3 border border-white/5">
                            <div class="flex justify-between font-black uppercase text-zinc-400"><span>üë§ ${o.userName}</span><span>${o.total}</span></div>
                            <div class="flex gap-2">
                                <button onclick="window.upStatus('${id}','ÿ≠ÿ∞ŸÅ')" class="bg-red-900/40 px-4 py-2 rounded-xl text-red-400">√ó</button>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        window.openProductModal = (id, n, p, img, cJ, sJ) => {
            const colors = cJ ? JSON.parse(decodeURIComponent(cJ)) : [];
            const sizes = sJ ? JSON.parse(decodeURIComponent(sJ)) : [];
            document.getElementById('modal-p-image').src = img;
            document.getElementById('modal-p-name').innerText = n;
            document.getElementById('modal-p-price').innerText = p + " EGP";
            curImg = img; curSz = sizes[0] || "";
            const qrEl = document.getElementById('qr-code'); qrEl.innerHTML = "";
            new QRCode(qrEl, { text: n, width: 65, height: 65 });

            const cl = document.getElementById('modal-colors-list'); cl.innerHTML = '';
            if(colors.length) {
                document.getElementById('modal-colors-area').classList.remove('hidden');
                colors.forEach((c, idx) => {
                    const dot = document.createElement('div'); dot.className = `color-dot ${idx===0?'active':''}`;
                    dot.style.backgroundColor = c.hex;
                    dot.onclick = () => { document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); dot.classList.add('active'); document.getElementById('modal-p-image').src = c.img; curImg = c.img; };
                    cl.appendChild(dot);
                });
            } else document.getElementById('modal-colors-area').classList.add('hidden');

            const sl = document.getElementById('modal-sizes-list'); sl.innerHTML = '';
            if(sizes.length) {
                document.getElementById('modal-sizes-area').classList.remove('hidden');
                sizes.forEach((s, idx) => {
                    const btn = document.createElement('button'); btn.className = `size-btn ${idx===0?'active':''}`; btn.innerText = s;
                    btn.onclick = () => { document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); curSz = s; };
                    sl.appendChild(btn);
                });
            } else document.getElementById('modal-sizes-area').classList.add('hidden');

            document.getElementById('product-modal').classList.remove('hidden');
        };

        // --- Button Handlers ---
        document.getElementById('next-btn').onclick = () => { if(document.getElementById('user-name-input').value) { document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.remove('hidden'); } };
        document.getElementById('auth-final-btn').onclick = async () => {
            const n = document.getElementById('user-name-input').value.trim();
            const p = document.getElementById('user-pass-input').value.trim();
            const snap = await get(ref(rdb, `${DB_ROOT}/users/${n}`));
            if(!snap.exists()) {
                await signInAnonymously(auth);
                await set(ref(rdb, `${DB_ROOT}/users/${n}`), { name: n, password: p, role: (n.toLowerCase()==='admin'?'admin':'user') });
            } else if(snap.val().password !== p) return showNotify("‚ö†Ô∏è ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©", "#f00");
            localStorage.setItem('es_session_v4', n);
            location.reload();
        };

        document.getElementById('save-shipping-btn').onclick = async () => {
            const sh = { name: document.getElementById('ship-fullname').value, phone: document.getElementById('ship-phone').value, address: document.getElementById('ship-address').value };
            if(!sh.name || !sh.phone || !sh.address) return showNotify("‚ö†Ô∏è ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ ŸÜÿßŸÇÿµÿ©", "#f00");
            const items = isDirect ? [{ name: document.getElementById('modal-p-name').innerText, price: parseInt(document.getElementById('modal-p-price').innerText), sz: curSz, img: curImg, qty: 1 }] : cart;
            const total = isDirect ? document.getElementById('modal-p-price').innerText : document.getElementById('cart-total').innerText;
            const orderData = { userName: profile.name, items, total, shipping: sh, status: 'Processing', timestamp: Date.now() };
            
            await push(ref(rdb, `${DB_ROOT}/orders`), orderData);
            sendAdminEmail(orderData); // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸÅŸàÿ±ÿßŸã
            
            document.getElementById('shipping-modal').classList.add('hidden');
            document.getElementById('product-modal').classList.add('hidden');
            showNotify("üöÄ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ Ÿàÿ≥ŸäÿµŸÑŸÉ ÿ•ŸäŸÖŸäŸÑ ÿ™ÿ£ŸÉŸäÿØ!", "#10b981");
        };

        document.getElementById('add-product-btn').onclick = async () => {
            const n = document.getElementById('p-name').value; const p = document.getElementById('p-price').value; 
            const s = document.getElementById('p-sizes').value.split(',').map(x=>x.trim());
            const cols = [];
            document.querySelectorAll('#colors-input-list .flex').forEach(d => {
                const img = d.querySelector('.c-img').value; const hex = d.querySelector('.c-hex').value;
                if(img) cols.push({img, hex});
            });
            await push(ref(rdb, `${DB_ROOT}/products`), { name: n, price: p, image: cols[0].img, sizes: s, colors: cols, timestamp: Date.now() });
            showNotify("‚ú® Published!"); location.reload();
        };

        window.delP = (id) => { if(confirm("ÿ≠ÿ∞ŸÅÿü")) remove(ref(rdb, `${DB_ROOT}/products/${id}`)); };
        window.upStatus = (id, st) => { if(st==='ÿ≠ÿ∞ŸÅ') remove(ref(rdb, `${DB_ROOT}/orders/${id}`)); };
        window.showPage = (id) => {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            document.getElementById('hero-section').classList.toggle('hidden', id !== 'home');
        };
        document.getElementById('admin-toggle-btn').onclick = () => document.getElementById('admin-panel').classList.toggle('hidden');
        document.getElementById('checkout-direct-btn').onclick = () => { isDirect = true; document.getElementById('shipping-modal').classList.remove('hidden'); };
        document.getElementById('close-p-modal').onclick = () => document.getElementById('product-modal').classList.add('hidden');
        document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };
        window.addColorInput = () => {
            const container = document.getElementById('colors-input-list');
            const div = document.createElement('div'); div.className = "flex gap-2 animate-in slide-in-from-right duration-300";
            div.innerHTML = `<input type="text" placeholder="ÿ±ÿßÿ®ÿ∑" class="flex-1 bg-white/5 p-3 rounded-xl text-xs c-img"><input type="color" class="w-12 h-12 rounded-xl c-hex cursor-pointer"><button onclick="this.parentElement.remove()" class="text-red-500 font-black">√ó</button>`;
            container.appendChild(div);
        };
    </script>
</body>
</html>