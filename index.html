<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Es Store | The Ultimate Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Playfair+Display:ital,wght@1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          emailjs.init("Ru84Q4SIEnQZjbfL4");
       })();
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { darkBg: '#0a0a0a', darkCard: '#141414' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden; }
        .logo-font { font-family: 'Playfair Display', serif; }
        .dark body { background-color: #0a0a0a; color: #fff; }
        .modal-content { max-height: 90vh; overflow-y: auto !important; border-radius: 2.5rem 2.5rem 0 0 !important; }
        @media (min-width: 768px) { 
            .modal-content { border-radius: 4rem !important; max-height: 85vh; display: flex; flex-direction: row; overflow-y: hidden !important; } 
            .modal-scroll-area { overflow-y: auto; max-height: 85vh; width: 50%; }
        }
        .hero-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8)); }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #eee; cursor: pointer; transition: 0.3s; }
        .color-dot.active { border-color: #000; transform: scale(1.15); }
        .dark .color-dot.active { border-color: #fff; }
        .size-btn { padding: 12px 20px; border-radius: 12px; border: 1.5px solid #eee; font-weight: 800; transition: 0.3s; }
        .size-btn.active { background: #000; color: #fff; border-color: #000; }
        .dark .size-btn.active { background: #fff; color: #000; border-color: #fff; }
        
        .fly-item {
            position: fixed; z-index: 5000; width: 80px; height: 80px; object-fit: cover; border-radius: 20px;
            pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #qrcode img { margin: 0 auto; border-radius: 1rem; border: 8px solid white; }
    </style>
</head>
<body class="light">

    <div id="login-screen" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 text-white text-center" style="background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.pexels.com/photos/1183266/pexels-photo-1183266.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover;">
        <div class="w-full max-w-sm bg-white/5 backdrop-blur-2xl p-10 rounded-[3.5rem] border border-white/10">
            <h1 class="logo-font text-8xl italic font-black mb-10">Es</h1>
            <div id="step-1" class="space-y-4">
                <input type="text" id="user-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="w-full p-5 rounded-2xl bg-white/10 text-center outline-none border border-white/5">
                <button id="next-btn" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all">Ù…ØªØ§Ø¨Ø¹Ø©</button>
            </div>
            <div id="step-2" class="hidden space-y-4">
                <input type="password" id="user-pass-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-5 rounded-2xl bg-white/10 text-center outline-none border border-white/5">
                <button id="auth-final-btn" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <header class="sticky top-0 z-[100] bg-white/80 dark:bg-zinc-950/80 backdrop-blur-lg border-b border-gray-100 dark:border-zinc-900">
            <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center w-full">
                <div class="flex items-center gap-4">
                    <span class="logo-font text-4xl font-black italic cursor-pointer dark:text-white" onclick="location.reload()">Es</span>
                    <button id="mode-toggle" class="p-2 bg-gray-100 dark:bg-zinc-800 rounded-full">
                        <svg id="sun-icon" class="w-5 h-5 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>
                        <svg id="moon-icon" class="w-5 h-5 block dark:hidden text-zinc-600" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-toggle-btn" class="hidden bg-black dark:bg-white dark:text-black text-white px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-[0.2em]">Dashboard</button>
                    <button id="cart-trigger" class="relative p-3 bg-gray-50 dark:bg-zinc-800 rounded-full transition-all">
                        <svg class="w-5 h-5 dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke-width="2"/></svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-black">0</span>
                    </button>
                    <button id="logout-btn" class="p-2 text-zinc-400 hover:text-red-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7" stroke-width="2"/></svg></button>
                </div>
            </div>
        </header>

        <div id="admin-panel" class="hidden bg-zinc-950 text-white p-6 border-b-[12px] border-black overflow-hidden animate-in slide-in-from-top duration-500">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12 text-right">
                <div class="space-y-5">
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.3em]">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="bg-white/5 p-6 rounded-[2.5rem] border border-white/5 space-y-4 text-right">
                        <input type="text" id="p-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <input type="text" id="p-sizes" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (S, M, L...)" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <input type="text" id="p-main-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" class="w-full bg-white/5 p-4 rounded-2xl outline-none">
                        <div id="colors-input-list" class="space-y-2"></div>
                        <button id="add-color-input-btn" class="text-[10px] font-black text-blue-400 uppercase tracking-widest">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† ÙˆØµÙˆØ±Ø© ÙØ±Ø¹ÙŠØ©</button>
                        <button id="add-product-btn" class="w-full bg-white text-black py-5 rounded-[1.5rem] font-black uppercase tracking-[0.2em]">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.3em] mb-6 text-right">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h3>
                    <div id="all-orders-admin" class="space-y-4 max-h-[600px] overflow-y-auto pr-3"></div>
                </div>
            </div>
        </div>

        <div id="hero-section" class="relative h-[60vh] w-full overflow-hidden">
            <img src="https://images.pexels.com/photos/1884581/pexels-photo-1884581.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 hero-gradient flex flex-col items-center justify-center text-white text-center px-6">
                <span class="text-[10px] font-black uppercase tracking-[0.6em] mb-4 opacity-70">Es Store Official</span>
                <h2 class="logo-font text-6xl md:text-8xl italic font-black mb-6">Style is Eternal</h2>
                <button onclick="document.getElementById('products-grid').scrollIntoView({behavior:'smooth'})" class="mt-10 px-10 py-5 bg-white text-black rounded-full font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all">Shop Collection</button>
            </div>
        </div>

        <main id="page-home" class="flex-1 px-4 py-16 max-w-7xl mx-auto w-full">
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-12"></div>
        </main>

        <main id="page-orders" class="hidden flex-1 px-4 py-12 max-w-3xl mx-auto w-full">
            <h2 class="text-4xl font-black italic logo-font mb-12 text-center dark:text-white">Order History</h2>
            <div id="my-orders-list" class="space-y-4"></div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 z-[200] bg-white/90 dark:bg-zinc-900/90 backdrop-blur-xl border-t border-gray-100 dark:border-zinc-800 flex justify-around py-4 md:hidden">
            <button onclick="window.showPage('home')" id="tab-home" class="nav-tab flex flex-col items-center gap-1 border-b-2 border-black dark:border-white pb-1">
                <span class="text-[10px] font-black uppercase tracking-widest dark:text-white">Store</span>
            </button>
            <button onclick="window.showPage('orders')" id="tab-orders" class="nav-tab flex flex-col items-center gap-1 opacity-40 pb-1">
                <span class="text-[10px] font-black uppercase tracking-widest dark:text-white">Orders</span>
            </button>
        </nav>
    </div>

    <div id="product-modal" class="fixed inset-0 z-[2500] bg-black/70 backdrop-blur-xl hidden flex items-end md:items-center justify-center">
        <div class="modal-content bg-white dark:bg-zinc-900 w-full max-w-5xl relative shadow-2xl overflow-hidden">
            <button id="close-p-modal" class="absolute top-6 right-6 z-[2600] bg-white/80 dark:bg-zinc-800 shadow-xl w-10 h-10 rounded-full text-2xl flex items-center justify-center font-light dark:text-white transition-transform active:scale-90">&times;</button>
            
            <div class="w-full md:w-1/2 bg-gray-50 dark:bg-zinc-800 p-4 md:p-10 flex flex-col items-center justify-center">
                <div class="w-full aspect-[4/5] rounded-[2.5rem] overflow-hidden bg-white shadow-2xl relative">
                    <img id="modal-p-image" src="" class="w-full h-full object-cover">
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="share-product-btn" class="flex items-center gap-2 bg-white dark:bg-zinc-700 px-6 py-3 rounded-2xl shadow-sm font-black text-[10px] uppercase tracking-widest dark:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" stroke-width="2"/></svg>
                        Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                    <button id="qr-trigger-btn" class="flex items-center justify-center bg-white dark:bg-zinc-700 w-12 h-12 rounded-2xl shadow-sm dark:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" stroke-width="2"/></svg>
                    </button>
                </div>
            </div>
            
            <div class="modal-scroll-area p-8 md:p-16 flex flex-col justify-center bg-white dark:bg-zinc-900 text-right">
                <div class="mb-10">
                    <span class="text-[10px] font-black uppercase tracking-[0.4em] text-zinc-400">Es Store Premium</span>
                    <h3 id="modal-p-name" class="text-4xl md:text-5xl font-black italic logo-font my-3 dark:text-white">Product</h3>
                    <p id="modal-p-price" class="text-2xl font-black text-zinc-300 italic">0 EGP</p>
                </div>
                
                <div id="modal-colors-area" class="mb-8 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-400 mb-4 tracking-[0.2em]">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
                    <div id="modal-colors-list" class="flex flex-wrap gap-4 justify-end"></div>
                </div>
                
                <div id="modal-sizes-area" class="mb-10 hidden">
                    <p class="text-[10px] font-black uppercase text-zinc-400 mb-4 tracking-[0.2em]">Ø§Ù„Ù…Ù‚Ø§Ø³</p>
                    <div id="modal-sizes-list" class="flex flex-wrap gap-3 justify-end"></div>
                </div>
                
                <div class="space-y-4">
                    <button id="checkout-direct-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-2xl font-black uppercase text-xs tracking-[0.2em]">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
                    <button id="modal-add-btn" class="w-full bg-white dark:bg-zinc-800 text-black dark:text-white border-2 border-zinc-100 dark:border-zinc-700 py-6 rounded-2xl font-black uppercase text-xs tracking-[0.2em]">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-[2700] bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div class="bg-white dark:bg-zinc-900 p-8 rounded-[3rem] text-center space-y-6 max-w-xs w-full" onclick="event.stopPropagation()">
            <h4 class="font-black italic text-xl dark:text-white">QR Code</h4>
            <div id="qrcode" class="flex justify-center p-4 bg-white rounded-2xl"></div>
            <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
        </div>
    </div>

    <div id="shipping-modal" class="fixed inset-0 z-[2600] bg-black/60 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl text-right">
            <h2 class="text-3xl font-black italic logo-font mb-8 text-center dark:text-white">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h2>
            <div class="space-y-4">
                <input type="text" id="ship-fullname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none font-bold">
                <input type="tel" id="ship-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none font-bold ltr text-left">
                <textarea id="ship-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="w-full p-5 rounded-2xl bg-zinc-50 dark:bg-zinc-800 dark:text-white outline-none h-28 font-bold"></textarea>
                <button id="save-shipping-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
            <button onclick="document.getElementById('shipping-modal').classList.add('hidden')" class="w-full mt-4 text-[10px] font-black text-zinc-400 uppercase tracking-widest">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="cart-drawer" class="fixed inset-0 z-[2400] bg-black/40 hidden text-right">
        <div id="cart-inner" class="absolute left-0 top-0 h-full w-full max-w-sm bg-white dark:bg-zinc-900 p-10 flex flex-col transform -translate-x-full transition-transform duration-500">
            <h2 class="text-4xl font-black italic logo-font mb-10 dark:text-white">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-5"></div>
            <div class="pt-8 border-t dark:border-zinc-800 mt-6">
                <div class="flex justify-between font-black text-2xl mb-8 italic dark:text-white"><span>Total</span><span id="cart-total">0 EGP</span></div>
                <button id="checkout-cart-btn" class="w-full bg-black dark:bg-white dark:text-black text-white py-6 rounded-[2rem] font-black uppercase text-xs tracking-widest">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
            </div>
            <button id="cart-close" class="mt-6 text-[10px] font-black text-zinc-400 uppercase tracking-widest text-center">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRVGDn1M_zy5p7HGsNV0dLweMKRs_5JzA",
            authDomain: "elshla.firebaseapp.com",
            databaseURL: "https://elshla-default-rtdb.firebaseio.com",
            projectId: "elshla",
            storageBucket: "elshla.firebasestorage.app",
            messagingSenderId: "225364230201",
            appId: "1:225364230201:web:ffa36b14888763a1e64de8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rdb = getDatabase(app);
        const DB_ROOT = "es_v_admin_pro"; 

        let profile = null; 
        let cart = [];
        let curImg = ""; let curSz = ""; let isDirect = false; let currentProductId = "";

        const showNotify = (msg, color="#000") => {
            Toastify({ text: msg, duration: 3000, gravity: "top", position: "center", style: { background: color, borderRadius: "20px", fontWeight: "bold" } }).showToast();
        };

        // --- History Logic ---
        function pushState(page, params = {}) {
            const url = new URL(window.location);
            Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
            window.history.pushState({ page }, "", url);
        }

        window.onpopstate = (e) => {
            ['product-modal', 'shipping-modal', 'cart-drawer', 'qr-modal'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if(e.state && e.state.page) window.showPage(e.state.page, false);
        };

        // --- Fly Animation ---
        function flyToCartAnimation(imgSrc) {
            const startEl = document.getElementById('modal-p-image');
            const cartEl = document.getElementById('cart-trigger');
            const startRect = startEl.getBoundingClientRect();
            const cartRect = cartEl.getBoundingClientRect();
            const flyImg = document.createElement('img');
            flyImg.src = imgSrc; flyImg.className = 'fly-item';
            flyImg.style.top = `${startRect.top}px`; flyImg.style.left = `${startRect.left}px`;
            flyImg.style.width = `${startRect.width}px`; flyImg.style.height = `${startRect.height}px`;
            document.body.appendChild(flyImg);
            setTimeout(() => {
                flyImg.style.top = `${cartRect.top}px`; flyImg.style.left = `${cartRect.left}px`;
                flyImg.style.width = '20px'; flyImg.style.height = '20px';
                flyImg.style.opacity = '0'; flyImg.style.transform = 'rotate(360deg)';
            }, 50);
            setTimeout(() => { flyImg.remove(); cartEl.classList.add('scale-125'); setTimeout(() => cartEl.classList.remove('scale-125'), 200); }, 850);
        }

        // --- Phone Logic ---
        const phoneInput = document.getElementById('ship-phone');
        phoneInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if(val.startsWith('0')) val = '+20' + val.substring(1);
            else if(val && !val.startsWith('+')) {
                if(val.startsWith('20')) val = '+' + val;
                else val = '+20' + val;
            }
            e.target.value = val;
        });

        // --- Dashboard Toggle Fix ---
        document.getElementById('admin-toggle-btn').onclick = () => {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
        };

        // --- Auth & Data Loading ---
        onAuthStateChanged(auth, async (u) => {
            const saved = localStorage.getItem('es_session_v4');
            if(saved) {
                onValue(ref(rdb, `${DB_ROOT}/users/${saved}`), (s) => {
                    profile = s.val();
                    if(profile) {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        if(profile.role === 'admin') document.getElementById('admin-toggle-btn').classList.remove('hidden');
                        loadData();
                        checkDeepLink();
                    }
                });
            }
        });

        function checkDeepLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('product');
            if(pid) {
                get(ref(rdb, `${DB_ROOT}/products/${pid}`)).then(s => {
                    if(s.exists()) {
                        const p = s.val();
                        window.openProductModal(pid, p.name, p.price, p.image, encodeURIComponent(JSON.stringify(p.colors||[])), encodeURIComponent(JSON.stringify(p.sizes||[])));
                    }
                });
            }
        }

        function loadData() {
            onValue(ref(rdb, `${DB_ROOT}/products`), (snap) => {
                const grid = document.getElementById('products-grid'); grid.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.keys(data).reverse().forEach(id => {
                    const p = data[id];
                    const cS = encodeURIComponent(JSON.stringify(p.colors || []));
                    const sS = encodeURIComponent(JSON.stringify(p.sizes || []));
                    grid.innerHTML += `
                        <div class="group cursor-pointer animate-in fade-in slide-in-from-bottom-5 duration-700" onclick="window.openProductModal('${id}','${p.name}',${p.price},'${p.image}','${cS}','${sS}')">
                            <div class="aspect-[3/4] rounded-[2.5rem] overflow-hidden bg-gray-50 dark:bg-zinc-800 relative">
                                <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-all duration-700">
                                ${profile && profile.role==='admin'?`<button onclick="event.stopPropagation(); window.delP('${id}')" class="absolute top-4 right-4 bg-red-600/80 backdrop-blur text-white w-8 h-8 rounded-full">Ã—</button>`:''}
                            </div>
                            <div class="mt-5 px-2 text-center">
                                <h4 class="font-black italic text-sm uppercase dark:text-white truncate">${p.name}</h4>
                                <p class="text-zinc-400 font-bold text-xs">${p.price} EGP</p>
                            </div>
                        </div>`;
                });
            });

            onValue(ref(rdb, `${DB_ROOT}/orders`), (snap) => {
                const my = document.getElementById('my-orders-list');
                const adm = document.getElementById('all-orders-admin');
                my.innerHTML = ''; adm.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.entries(data).reverse().forEach(([id, o]) => {
                    if(profile && o.userName === profile.name) {
                        my.innerHTML += `<div class="bg-gray-50 dark:bg-zinc-800 p-6 rounded-[2rem] flex justify-between items-center text-right shadow-sm border border-transparent hover:border-zinc-200 transition-all">
                            <div><p class="font-black text-xs uppercase dark:text-white">${o.items.map(i=>i.name).join(', ')}</p><p class="text-[10px] text-zinc-400 mt-1 uppercase font-bold tracking-widest">${o.status}</p></div>
                            <div class="font-black dark:text-white">${o.total}</div>
                        </div>`;
                    }
                    if(profile && profile.role==='admin') {
                        adm.innerHTML += `<div class="bg-white/5 p-6 rounded-3xl text-[10px] space-y-3 border border-white/5">
                            <div class="flex justify-between font-black uppercase text-zinc-400"><span>ğŸ‘¤ ${o.userName}</span><span>${o.total}</span></div>
                            <div class="text-white/60">ğŸ“¦ ${o.items.map(i=>i.name).join(' + ')}</div>
                            <div class="text-zinc-500 italic">ğŸ“ ${o.shipping.phone} | ğŸ“ ${o.shipping.address}</div>
                            <div class="flex flex-wrap gap-2 pt-2">
                                <button onclick="window.processOrder('${id}', 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', '${encodeURIComponent(JSON.stringify(o))}')" class="bg-green-600/20 text-green-400 border border-green-600/30 px-4 py-2 rounded-xl font-bold">ØªÙˆØµÙŠÙ„ âœ…</button>
                                <button onclick="window.upStatus('${id}','Ø­Ø°Ù')" class="bg-red-900/40 px-4 py-2 rounded-xl text-red-400">Ø­Ø°Ù</button>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        window.openProductModal = (id, n, p, img, cJ, sJ) => {
            currentProductId = id;
            const colors = JSON.parse(decodeURIComponent(cJ));
            const sizes = JSON.parse(decodeURIComponent(sJ));
            document.getElementById('modal-p-image').src = img;
            document.getElementById('modal-p-name').innerText = n;
            document.getElementById('modal-p-price').innerText = p + " EGP";
            curImg = img; curSz = sizes[0] || "";

            const cl = document.getElementById('modal-colors-list'); cl.innerHTML = '';
            if(colors.length) {
                document.getElementById('modal-colors-area').classList.remove('hidden');
                colors.forEach((c, idx) => {
                    const dot = document.createElement('div'); dot.className = `color-dot ${idx===0?'active':''}`;
                    dot.style.backgroundColor = c.hex;
                    dot.onclick = () => { 
                        document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); 
                        dot.classList.add('active'); 
                        document.getElementById('modal-p-image').src = c.img; 
                        curImg = c.img; 
                    };
                    cl.appendChild(dot);
                });
            } else document.getElementById('modal-colors-area').classList.add('hidden');

            const sl = document.getElementById('modal-sizes-list'); sl.innerHTML = '';
            if(sizes.length) {
                document.getElementById('modal-sizes-area').classList.remove('hidden');
                sizes.forEach((s, idx) => {
                    const btn = document.createElement('button'); btn.className = `size-btn ${idx===0?'active':''}`; btn.innerText = s;
                    btn.onclick = () => { 
                        document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active')); 
                        btn.classList.add('active'); 
                        curSz = s; 
                    };
                    sl.appendChild(btn);
                });
            } else document.getElementById('modal-sizes-area').classList.add('hidden');

            document.getElementById('product-modal').classList.remove('hidden');
            pushState('product', { product: id });
        };

        // --- Share & QR ---
        document.getElementById('share-product-btn').onclick = async () => {
            const url = `${window.location.origin}${window.location.pathname}?product=${currentProductId}`;
            if (navigator.share) {
                navigator.share({ title: document.getElementById('modal-p-name').innerText, url: url });
            } else {
                const dummy = document.createElement('input');
                document.body.appendChild(dummy);
                dummy.value = url; dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                showNotify("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ğŸ”—");
            }
        };

        document.getElementById('qr-trigger-btn').onclick = () => {
            const url = `${window.location.origin}${window.location.pathname}?product=${currentProductId}`;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
            document.getElementById('qr-modal').classList.remove('hidden');
        };

        // --- Order & EmailJS ---
        document.getElementById('save-shipping-btn').onclick = async () => {
            const sh = { 
                name: document.getElementById('ship-fullname').value, 
                phone: document.getElementById('ship-phone').value, 
                address: document.getElementById('ship-address').value 
            };
            if(!sh.name || !sh.phone || !sh.address) return showNotify("âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","red");
            
            const items = isDirect ? [{ name: document.getElementById('modal-p-name').innerText, price: parseInt(document.getElementById('modal-p-price').innerText), sz: curSz, img: curImg, qty: 1 }] : cart;
            const total = items.reduce((acc, i) => acc + (i.price * i.qty), 0);
            
            // 1. Save to Firebase
            await push(ref(rdb, `${DB_ROOT}/orders`), { userName: profile.name, items, total, shipping: sh, status: 'Processing', timestamp: Date.now() });
            
            // 2. Send Email via EmailJS (Modified to include size and color link)
            const itemsList = items.map(i => `â€¢ ${i.name} (${i.sz}) x${i.qty} \n  Ø§Ù„Ù„ÙˆÙ†: ${i.img}`).join('\n\n');
            emailjs.send("service_xsnqf3u", "template_y8p7d8o", {
                from_name: profile.name,
                customer_name: sh.name,
                customer_phone: sh.phone,
                customer_address: sh.address,
                order_items: itemsList,
                total_price: total + " EGP",
                message: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${profile.name}`
            }).catch(err => console.error("Email Error:", err));

            if(!isDirect) cart = [];
            window.updateCartUI();
            ['shipping-modal', 'product-modal', 'cart-drawer'].forEach(m=>document.getElementById(m).classList.add('hidden'));
            showNotify("ğŸš€ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!","#10b981");
            window.showPage('orders');
        };

        // --- Helper Functions ---
        window.updateCartUI = () => {
            document.getElementById('cart-count').innerText = cart.reduce((acc, i) => acc + i.qty, 0);
            const container = document.getElementById('cart-items'); container.innerHTML = '';
            let total = 0;
            cart.forEach((item, idx) => {
                total += item.price * item.qty;
                container.innerHTML += `<div class="flex items-center gap-4 bg-gray-50 dark:bg-zinc-800 p-4 rounded-3xl">
                    <img src="${item.img}" class="w-16 h-16 object-cover rounded-xl shadow-md">
                    <div class="flex-1"><h4 class="font-black text-[10px] dark:text-white uppercase">${item.name}</h4><p class="text-[9px] text-zinc-400 font-bold">${item.sz} | ${item.price} EGP</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="window.changeQty(${idx},-1)" class="w-6 h-6 bg-white dark:bg-zinc-700 rounded-lg text-xs font-black dark:text-white shadow-sm">-</button>
                        <span class="text-xs font-black dark:text-white w-4 text-center">${item.qty}</span>
                        <button onclick="window.changeQty(${idx},1)" class="w-6 h-6 bg-white dark:bg-zinc-700 rounded-lg text-xs font-black dark:text-white shadow-sm">+</button>
                    </div>
                </div>`;
            });
            document.getElementById('cart-total').innerText = total + " EGP";
        };

        window.changeQty = (idx, delta) => { cart[idx].qty += delta; if(cart[idx].qty < 1) cart.splice(idx, 1); window.updateCartUI(); };
        window.showPage = (id, push = true) => {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            document.getElementById('hero-section').classList.toggle('hidden', id !== 'home');
            document.querySelectorAll('.nav-tab').forEach(t=>t.classList.add('opacity-40'));
            document.getElementById(`tab-${id}`).classList.remove('opacity-40');
            if(push) pushState(id);
        };

        // UI Listeners
        document.getElementById('modal-add-btn').onclick = () => {
            const name = document.getElementById('modal-p-name').innerText;
            const price = parseInt(document.getElementById('modal-p-price').innerText);
            cart.push({ name, price, sz: curSz, img: curImg, qty: 1 });
            flyToCartAnimation(curImg);
            window.updateCartUI();
            showNotify("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©");
        };

        document.getElementById('checkout-cart-btn').onclick = () => {
            if(!cart.length) return showNotify("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©","red");
            isDirect = false;
            document.getElementById('shipping-modal').classList.remove('hidden');
        };

        document.getElementById('checkout-direct-btn').onclick = () => {
            isDirect = true;
            document.getElementById('shipping-modal').classList.remove('hidden');
        };

        document.getElementById('cart-trigger').onclick = () => {
            document.getElementById('cart-drawer').classList.remove('hidden');
            setTimeout(() => document.getElementById('cart-inner').classList.remove('-translate-x-full'), 10);
        };

        document.getElementById('cart-close').onclick = () => {
            document.getElementById('cart-inner').classList.add('-translate-x-full');
            setTimeout(() => document.getElementById('cart-drawer').classList.add('hidden'), 500);
        };

        document.getElementById('close-p-modal').onclick = () => {
            document.getElementById('product-modal').classList.add('hidden');
            window.history.back();
        };

        document.getElementById('add-product-btn').onclick = async () => {
            const p = { 
                name: document.getElementById('p-name').value, 
                price: document.getElementById('p-price').value, 
                image: document.getElementById('p-main-img').value, 
                sizes: document.getElementById('p-sizes').value.split(','), 
                colors: [] 
            };
            document.querySelectorAll('#colors-input-list > div').forEach(div => {
                p.colors.push({ img: div.querySelector('.c-img').value, hex: div.querySelector('.c-hex').value });
            });
            await push(ref(rdb, `${DB_ROOT}/products`), p);
            showNotify("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø±");
        };

        document.getElementById('add-color-input-btn').onclick = () => {
            const container = document.getElementById('colors-input-list');
            const div = document.createElement('div'); div.className = "flex gap-2 p-2 bg-white/5 rounded-2xl";
            div.innerHTML = `<input type="text" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù„ÙˆÙ†" class="flex-1 bg-transparent p-2 text-xs c-img outline-none"><input type="color" class="w-10 h-10 rounded-xl c-hex cursor-pointer"><button onclick="this.parentElement.remove()" class="text-red-500 px-2 font-black">Ã—</button>`;
            container.appendChild(div);
        };

        document.getElementById('mode-toggle').onclick = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
        if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        document.getElementById('next-btn').onclick = () => {
            if(document.getElementById('user-name-input').value) {
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
            }
        };

        document.getElementById('auth-final-btn').onclick = async () => {
            const n = document.getElementById('user-name-input').value.trim();
            const p = document.getElementById('user-pass-input').value.trim();
            const snap = await get(ref(rdb, `${DB_ROOT}/users/${n}`));
            if(!snap.exists()) {
                await signInAnonymously(auth);
                await set(ref(rdb, `${DB_ROOT}/users/${n}`), { name: n, password: p, role: (n.toLowerCase()==='admin'?'admin':'user') });
            } else if(snap.val().password !== p) return showNotify("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©", "#f00");
            localStorage.setItem('es_session_v4', n); location.reload();
        };

        document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };

        window.delP = (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) remove(ref(rdb, `${DB_ROOT}/products/${id}`)); };
        window.upStatus = (id, st) => { if(st==='Ø­Ø°Ù') remove(ref(rdb, `${DB_ROOT}/orders/${id}`)); };
        window.processOrder = async (id, status, oRaw) => {
            const o = JSON.parse(decodeURIComponent(oRaw));
            await update(ref(rdb, `${DB_ROOT}/orders/${id}`), { status: status });
            const msg = `Ø£Ù‡Ù„Ø§Ù‹ ${o.shipping.name} âœ¨%0AØ·Ù„Ø¨Ùƒ ÙÙŠ Es Store ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ù€: ${status}%0AğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total}%0AğŸšš Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ!`;
            window.open(`https://wa.me/${o.shipping.phone.replace('+', '')}?text=${msg}`, '_blank');
        };
    </script>
</body>
</html>